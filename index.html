<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Agenda AI - Google Integration</title>
    
    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- ‚≠ê CONFIGURAZIONE CENTRALIZZATA - CARICA SEMPRE PER PRIMO -->
    <script src="config.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 100vw;
            margin: 0;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* INDICATORE CONFIGURAZIONE */
        .config-status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            z-index: 9999;
            display: none;
            transition: all 0.3s ease;
        }

        .config-status.show { display: block; }
        .config-status.valid { background: rgba(39, 174, 96, 0.9); }
        .config-status.invalid { background: rgba(231, 76, 60, 0.9); }
        .config-status.warning { background: rgba(243, 156, 18, 0.9); }

        /* HEADER COMPATTO */
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1 {
            font-size: 1.8em;
            margin: 0;
        }

        .week-nav {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .nav-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .current-week {
            font-size: 1.1em;
            font-weight: bold;
            color: #ecf0f1;
            margin: 0 10px;
        }

        .header-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .google-status, .sync-status {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .google-indicator, .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .google-indicator.connected, .sync-indicator.connected { background: #27ae60; }
        .google-indicator.connecting, .sync-indicator.connecting { background: #f39c12; }
        .google-indicator.syncing, .sync-indicator.syncing { background: #f39c12; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .google-auth-btn {
            background: #db4437;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .google-auth-btn:hover {
            background: #c33d2e;
        }

        /* NOTIFICATION BAR */
        .notification-bar {
            background: #3498db;
            color: white;
            padding: 8px 20px;
            text-align: center;
            font-size: 12px;
            display: none;
            transition: all 0.3s ease;
        }

        .notification-bar.show { display: block; }
        .notification-bar.success { background: #27ae60; }
        .notification-bar.error { background: #e74c3c; }
        .notification-bar.warning { background: #f39c12; }

        /* TOP NAVIGATION TABS */
        .top-nav {
            background: #34495e;
            border-bottom: 2px solid #3498db;
            padding: 0;
            display: flex;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .top-nav::-webkit-scrollbar { display: none; }

        .nav-tab {
            flex: 1;
            min-width: 100px;
            padding: 12px 16px;
            background: transparent;
            color: #bdc3c7;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
        }

        .nav-tab.active {
            background: #3498db;
            color: white;
            border-bottom-color: #2980b9;
        }

        /* MAIN LAYOUT */
        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 0;
            min-height: calc(100vh - 130px);
        }

        /* WEEKLY CALENDAR */
        .calendar-section {
            padding: 20px;
            background: #f8f9fa;
            overflow-y: auto;
        }

        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .calendar-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background: #2980b9;
        }

        .action-btn.google { background: #db4437; }
        .action-btn.google:hover { background: #c33d2e; }

        .action-btn.ai { background: #9b59b6; }
        .action-btn.ai:hover { background: #8e44ad; }

        .weekly-grid {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            gap: 1px;
            background: #bdc3c7;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .time-header {
            background: #34495e;
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
        }

        .day-header {
            background: #34495e;
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: bold;
            font-size: 13px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .day-header.today {
            background: #f39c12;
        }

        .day-date {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .day-name {
            font-size: 11px;
            opacity: 0.9;
        }

        .time-slot {
            background: #2c3e50;
            color: white;
            padding: 10px 8px;
            text-align: center;
            font-size: 11px;
            font-weight: bold;
        }

        .day-cell {
            background: white;
            min-height: 60px;
            padding: 4px;
            position: relative;
            border-right: 1px solid #ecf0f1;
            cursor: pointer;
            transition: all 0.2s;
        }

        .day-cell:hover {
            background: #e8f4fd;
        }

        .day-cell.selected {
            background: #d5e8ff;
            border: 2px solid #3498db;
        }

        .day-cell.conflict {
            background: #fdf2f2;
            border-left: 3px solid #e74c3c;
        }

        .cell-content {
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .event-chip {
            background: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: relative;
        }

        .event-chip:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .event-chip.work { background: #3498db; }
        .event-chip.personal { background: #27ae60; }
        .event-chip.medical { background: #e67e22; }
        .event-chip.house { background: #8e44ad; }
        .event-chip.email-task { 
            background: #e91e63; 
            border-left: 3px solid #ad1457;
        }
        .event-chip.routine { background: #95a5a6; }
        .event-chip.project { background: #f39c12; }
        .event-chip.google-event { 
            background: #db4437; 
            border-left: 3px solid #c33d2e;
        }

        .event-source {
            position: absolute;
            top: 1px;
            right: 2px;
            font-size: 8px;
            opacity: 0.8;
        }

        /* SIDEBAR */
        .sidebar {
            background: #2c3e50;
            color: white;
            padding: 20px;
            overflow-y: auto;
            border-left: 2px solid #34495e;
        }

        /* TAB CONTENT STYLES */
        .tab-content {
            display: none;
            height: 100%;
        }

        .tab-content.active {
            display: block;
        }

        .section-card {
            background: #34495e;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
        }

        .section-title {
            color: #ecf0f1;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stats-mini {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .stat-mini {
            background: #34495e;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-mini-number {
            font-size: 20px;
            font-weight: bold;
            color: #3498db;
            display: block;
        }

        .stat-mini-label {
            font-size: 10px;
            color: #bdc3c7;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            color: #ecf0f1;
            font-size: 11px;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 6px 8px;
            border: none;
            border-radius: 4px;
            background: #2c3e50;
            color: white;
            font-size: 11px;
            border: 1px solid transparent;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            background: #1a252f;
        }

        .form-control::placeholder {
            color: #bdc3c7;
        }

        select.form-control {
            cursor: pointer;
        }

        .btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            width: 100%;
            transition: all 0.3s;
            margin-bottom: 6px;
        }

        .btn:hover {
            background: #219a52;
        }

        .btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 10px;
            width: auto;
            display: inline-block;
            margin: 2px;
        }

        .btn-database { background: #9b59b6; }
        .btn-database:hover { background: #8e44ad; }

        .btn-sync { background: #3498db; }
        .btn-sync:hover { background: #2980b9; }

        .btn-ai { background: #e67e22; }
        .btn-ai:hover { background: #d35400; }

        .btn-google { background: #db4437; }
        .btn-google:hover { background: #c33d2e; }

        /* LOADING SPINNER */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #bdc3c7;
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* DAILY SCHEDULE */
        .daily-schedule {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .schedule-header {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .time-slot-detail {
            display: flex;
            margin-bottom: 15px;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .time-slot-detail:hover {
            background: #f8f9fa;
        }

        .time-label {
            width: 80px;
            font-weight: bold;
            color: #34495e;
            font-size: 1.1em;
        }

        .time-content {
            flex: 1;
            padding-left: 15px;
        }

        .activity {
            background: #ecf0f1;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 5px;
            border-left: 4px solid #3498db;
            cursor: pointer;
            transition: all 0.2s;
        }

        .activity:hover {
            background: #e8f4fd;
            transform: translateX(5px);
        }

        .activity.fixed {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }

        .activity.flexible {
            border-left-color: #27ae60;
            background: #f2fdf2;
        }

        /* AI SUGGESTION POPUP */
        .ai-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            z-index: 2000;
            display: none;
            animation: aiPopupSlideIn 0.3s ease-out;
        }

        @keyframes aiPopupSlideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1) translateY(0);
            }
        }

        .ai-popup-header {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
            padding: 15px 20px;
            margin: -25px -25px 20px -25px;
            border-radius: 15px 15px 0 0;
            position: relative;
        }

        .ai-popup-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 18px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
        }

        .ai-suggestion {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #9b59b6;
        }

        .ai-suggestion-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .ai-suggestion-content {
            color: #7f8c8d;
            font-size: 14px;
            line-height: 1.4;
        }

        .ai-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .ai-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .ai-btn.accept {
            background: #27ae60;
            color: white;
        }

        .ai-btn.reject {
            background: #e74c3c;
            color: white;
        }

        /* EMAIL ANALYSIS */
        .email-item {
            background: #2c3e50;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            border-left: 3px solid #e91e63;
        }

        .email-subject {
            color: #ecf0f1;
            font-weight: bold;
            font-size: 11px;
            margin-bottom: 4px;
        }

        .email-from {
            color: #bdc3c7;
            font-size: 10px;
            margin-bottom: 6px;
        }

        .email-analysis {
            background: #1a252f;
            border-radius: 4px;
            padding: 6px;
            color: #e91e63;
            font-size: 10px;
            margin-bottom: 6px;
        }

        .email-actions {
            display: flex;
            gap: 4px;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }

            .sidebar {
                max-height: 50vh;
                border-left: none;
                border-top: 2px solid #34495e;
            }

            .weekly-grid {
                grid-template-columns: 60px repeat(7, 1fr);
                gap: 0;
            }

            .header-right {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Indicatore stato configurazione -->
    <div id="configStatus" class="config-status">
        üîß Caricamento configurazione...
    </div>

    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div class="header-left">
                <h1 id="appTitle">üéØ Agenda AI</h1>
                <div class="week-nav">
                    <button class="nav-btn" onclick="previousWeek()">‚Üê</button>
                    <div class="current-week" id="currentWeek"></div>
                    <button class="nav-btn" onclick="nextWeek()">‚Üí</button>
                    <button class="nav-btn" onclick="goToCurrentWeek()">Oggi</button>
                </div>
            </div>
            
            <div class="header-right">
                <div class="google-status">
                    <div class="google-indicator" id="googleIndicator"></div>
                    <span id="googleStatusText" style="font-size: 11px;">Google...</span>
                    <button class="google-auth-btn" id="googleAuthBtn" onclick="toggleGoogleAuth()">
                        üìß Connetti
                    </button>
                </div>
                
                <div class="sync-status">
                    <div class="sync-indicator" id="syncIndicator"></div>
                    <span id="syncStatusText" style="font-size: 11px;">DB...</span>
                </div>
            </div>
        </div>

        <!-- NOTIFICATION BAR -->
        <div class="notification-bar" id="notificationBar"></div>

        <!-- TOP NAVIGATION TABS -->
        <div class="top-nav">
            <button class="nav-tab active" onclick="switchMainTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="switchMainTab('tasks')">‚úÖ Task</button>
            <button class="nav-tab" onclick="switchMainTab('google')">üìß Google</button>
            <button class="nav-tab" onclick="switchMainTab('ai')">ü§ñ AI Assistant</button>
            <button class="nav-tab" onclick="switchMainTab('clients')">üë• Clienti</button>
            <button class="nav-tab" onclick="switchMainTab('projects')">üìã Progetti</button>
            <button class="nav-tab" onclick="switchMainTab('import')">üì§ Import/Export</button>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- WEEKLY CALENDAR -->
            <div class="calendar-section">
                <div class="calendar-controls">
                    <div>
                        <strong id="weekRange">Settimana Corrente</strong>
                    </div>
                    <div class="calendar-actions">
                        <button class="action-btn google" onclick="syncGoogleCalendar()">üìÖ Sync Calendar</button>
                        <button class="action-btn ai" onclick="analyzeOptimalSlots()">ü§ñ Ottimizza</button>
                        <button class="action-btn" onclick="detectConflicts()">‚ö†Ô∏è Conflitti</button>
                    </div>
                </div>

                <div class="weekly-grid" id="weeklyGrid">
                    <!-- Generato dinamicamente -->
                </div>
                
                <div class="daily-schedule">
                    <div class="schedule-header">üìÖ Programma del <span id="selectedDate">Oggi</span></div>
                    <div id="dailySchedule">
                        <div style="text-align: center; color: #7f8c8d; font-style: italic; padding: 20px;">
                            Seleziona una data nel calendario per vedere il programma dettagliato
                        </div>
                    </div>
                </div>
            </div>

            <!-- SIDEBAR DINAMICA -->
            <div class="sidebar">
                <!-- DASHBOARD TAB -->
                <div id="tab-dashboard" class="tab-content active">
                    <div class="stats-mini">
                        <div class="stat-mini">
                            <span class="stat-mini-number" id="tasksToday">-</span>
                            <span class="stat-mini-label">Task Oggi</span>
                        </div>
                        <div class="stat-mini">
                            <span class="stat-mini-number" id="googleEvents">-</span>
                            <span class="stat-mini-label">Google Events</span>
                        </div>
                        <div class="stat-mini">
                            <span class="stat-mini-number" id="emailTasks">-</span>
                            <span class="stat-mini-label">Email Tasks</span>
                        </div>
                        <div class="stat-mini">
                            <span class="stat-mini-number" id="conflictsCount">-</span>
                            <span class="stat-mini-label">Conflitti</span>
                        </div>
                    </div>

                    <div class="section-card">
                        <div class="section-title">‚ö° Azioni Dashboard</div>
                        <button class="btn btn-sync" onclick="refreshAllData()">
                            <span id="refreshSpinner"></span>
                            üîÑ Sincronizza Tutto
                        </button>
                        <button class="btn btn-google" onclick="fullGoogleSync()">
                            üìß Sync Completo Google
                        </button>
                        <button class="btn btn-ai" onclick="analyzeAndSuggest()">
                            ü§ñ Analizza & Suggerisci
                        </button>
                    </div>

                    <div class="section-card">
                        <div class="section-title">üìà Statistiche AI</div>
                        <div style="color: #bdc3c7; font-size: 10px; line-height: 1.4;">
                            <div>üß† Task auto-generati: <span id="aiGeneratedTasks">0</span></div>
                            <div>üìß Email analizzate: <span id="emailsAnalyzed">0</span></div>
                            <div>‚è∞ Slot ottimizzati: <span id="optimizedSlots">0</span></div>
                            <div>üéØ Accuracy rate: <span id="aiAccuracy">95%</span></div>
                        </div>
                    </div>
                </div>

                <!-- TASKS TAB -->
                <div id="tab-tasks" class="tab-content">
                    <div class="section-card">
                        <div class="section-title">‚ûï Nuovo Task</div>
                        <div class="form-group">
                            <label for="taskTitle">Titolo</label>
                            <input type="text" id="taskTitle" class="form-control" placeholder="Sviluppo homepage">
                        </div>
                        <div class="form-group">
                            <label for="taskClient">Cliente</label>
                            <select id="taskClient" class="form-control">
                                <option value="">Seleziona...</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                            <div class="form-group">
                                <label for="taskDate">Data</label>
                                <input type="date" id="taskDate" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="taskTime">Ora</label>
                                <input type="time" id="taskTime" class="form-control">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="taskDuration">Durata (ore)</label>
                            <select id="taskDuration" class="form-control">
                                <option value="0.5">30 min</option>
                                <option value="1" selected>1 ora</option>
                                <option value="1.5">1.5 ore</option>
                                <option value="2">2 ore</option>
                                <option value="3">3 ore</option>
                                <option value="4">4 ore</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="taskType">Categoria</label>
                            <select id="taskType" class="form-control">
                                <option value="work">üíº Lavoro</option>
                                <option value="personal">üë§ Personale</option>
                                <option value="medical">üíä Cure Annamaria</option>
                                <option value="garden">üå± Orto/Giardino</option>
                                <option value="house">üè† Casa</option>
                                <option value="project">üìã Progetto</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="syncToGoogle" checked> 
                                Sincronizza con Google Calendar
                            </label>
                        </div>
                        <button class="btn" onclick="addNewTask()">
                            <span id="addTaskSpinner"></span>
                            Aggiungi Task
                        </button>
                        <button class="btn btn-ai" onclick="suggestOptimalTime()">
                            ü§ñ Trova Slot Ottimale
                        </button>
                    </div>

                    <div id="conflictWarning" class="conflict-warning" style="display: none;">
                        <span class="conflict-warning-icon">‚ö†Ô∏è</span>
                        <span id="conflictText">Conflitto rilevato!</span>
                    </div>
                </div>

                <!-- GOOGLE TAB -->
                <div id="tab-google" class="tab-content">
                    <div class="section-card">
                        <div class="section-title">üìß Stato Google</div>
                        <div style="color: #bdc3c7; font-size: 10px; line-height: 1.4; margin-bottom: 10px;">
                            <div>üìÖ Calendar: <span id="calendarStatus">Disconnesso</span></div>
                            <div>üìß Gmail: <span id="gmailStatus">Disconnesso</span></div>
                            <div>üîÑ Ultimo sync: <span id="lastGoogleSync">-</span></div>
                            <div>üìä Eventi trovati: <span id="googleEventsCount">0</span></div>
                        </div>
                        <button class="btn btn-google" onclick="connectGoogle()">
                            üìß Connetti Google
                        </button>
                        <button class="btn btn-sync" onclick="syncGoogleCalendar()">
                            üìÖ Sync Calendar
                        </button>
                        <button class="btn btn-ai" onclick="analyzeEmails()">
                            üìß Analizza Email
                        </button>
                    </div>

                    <div class="section-card">
                        <div class="section-title">üìß Email Analysis</div>
                        <div id="emailAnalysisList" style="max-height: 200px; overflow-y: auto;">
                            <div style="text-align: center; color: #bdc3c7; font-style: italic; padding: 20px;">
                                Connetti Gmail per analizzare le email
                            </div>
                        </div>
                        <button class="btn btn-small" onclick="processEmailTasks()">‚úÖ Crea Task da Email</button>
                    </div>
                </div>

                <!-- AI ASSISTANT TAB -->
                <div id="tab-ai" class="tab-content">
                    <div class="section-card">
                        <div class="section-title">ü§ñ AI Assistant</div>
                        <div class="form-group">
                            <label for="aiPrompt">Cosa vuoi fare?</label>
                            <textarea id="aiPrompt" class="form-control" rows="3" placeholder="Es: Programma un meeting con Mario Rossi per domani mattina..."></textarea>
                        </div>
                        <button class="btn btn-ai" onclick="processAIRequest()">
                            ü§ñ Elabora Richiesta
                        </button>
                        <button class="btn btn-sync" onclick="optimizeWeekSchedule()">
                            üìä Ottimizza Settimana
                        </button>
                    </div>

                    <div class="section-card">
                        <div class="section-title">üí° Suggerimenti AI</div>
                        <div id="aiSuggestionsList" style="max-height: 200px; overflow-y: auto;">
                            <div style="color: #bdc3c7; font-style: italic; font-size: 11px;">
                                L'AI analizzer√† il tuo calendario e suggerir√† ottimizzazioni...
                            </div>
                        </div>
                    </div>

                    <div class="section-card">
                        <div class="section-title">‚öôÔ∏è Impostazioni AI</div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="autoScheduling" checked> 
                                Scheduling automatico
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="emailAutoTask" checked> 
                                Task automatici da email
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="conflictDetection" checked> 
                                Rilevamento conflitti
                            </label>
                        </div>
                    </div>
                </div>

                <!-- CLIENTS TAB -->
                <div id="tab-clients" class="tab-content">
                    <div class="section-card">
                        <div class="section-title">üë• Gestione Clienti</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 10px;">
                            <button class="btn" onclick="showAddClientForm()">‚ûï Nuovo</button>
                            <button class="btn btn-sync" onclick="loadClients()">üîÑ Ricarica</button>
                        </div>
                        <div id="clientsList" style="max-height: 200px; overflow-y: auto;">
                            <div style="text-align: center; color: #bdc3c7; font-style: italic; padding: 20px;">
                                Caricamento clienti...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PROJECTS TAB -->
                <div id="tab-projects" class="tab-content">
                    <div class="section-card">
                        <div class="section-title">üìã Progetti Attivi</div>
                        <div id="projectsList" style="max-height: 200px; overflow-y: auto;">
                            <div style="text-align: center; color: #bdc3c7; font-style: italic; padding: 20px;">
                                Caricamento progetti...
                            </div>
                        </div>
                        <button class="btn" onclick="showAddProjectForm()">‚ûï Nuovo Progetto</button>
                    </div>
                </div>

                <!-- IMPORT/EXPORT TAB -->
                <div id="tab-import" class="tab-content">
                    <div class="section-card">
                        <div class="section-title">üì§ Export Dati</div>
                        <button class="btn btn-sync" onclick="exportToCSV()">üìä Esporta CSV</button>
                        <button class="btn btn-sync" onclick="exportToJSON()">üìÑ Esporta JSON</button>
                        <button class="btn btn-sync" onclick="exportToXML()">üóÇÔ∏è Esporta XML</button>
                        <button class="btn btn-google" onclick="exportToGoogleCalendar()">üìÖ Export Google Calendar</button>
                    </div>

                    <div class="section-card">
                        <div class="section-title">üì• Import Dati</div>
                        <input type="file" id="importFileInput" accept=".csv,.json,.xml,.ics" style="display: none;" onchange="handleFileImport(event)">
                        <button class="btn btn-ai" onclick="document.getElementById('importFileInput').click()">üìÅ Seleziona File</button>
                        <div style="color: #bdc3c7; font-size: 10px; margin-top: 8px; line-height: 1.3;">
                            Formati supportati:<br>
                            ‚Ä¢ CSV (task, clienti)<br>
                            ‚Ä¢ JSON (backup completo)<br>
                            ‚Ä¢ XML (task strutturati)<br>
                            ‚Ä¢ ICS (calendario)
                        </div>
                    </div>

                    <div class="section-card">
                        <div class="section-title">üîÑ Raccolta Differenziata</div>
                        <button class="btn btn-database" onclick="importWasteCollection()">üóëÔ∏è Carica Calendario Rifiuti</button>
                        <div style="color: #bdc3c7; font-size: 10px; margin-top: 8px;">
                            Importa automaticamente il calendario raccolta differenziata 2025 per Chieti
                        </div>
                    </div>

                    <div id="importStatus" class="section-card" style="display: none;">
                        <div class="section-title">üìä Stato Import</div>
                        <div id="importResults" style="color: #bdc3c7; font-size: 11px; line-height: 1.4;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI SUGGESTION POPUP -->
    <div class="ai-popup" id="aiPopup">
        <div class="ai-popup-header">
            <h3>ü§ñ Suggerimento AI</h3>
            <button class="ai-popup-close" onclick="closeAIPopup()">√ó</button>
        </div>
        
        <div class="ai-suggestion">
            <div class="ai-suggestion-title" id="aiSuggestionTitle">Slot ottimale trovato!</div>
            <div class="ai-suggestion-content" id="aiSuggestionContent">
                Suggerimento AI...
            </div>
        </div>
        
        <div class="ai-actions">
            <button class="ai-btn reject" onclick="closeAIPopup()">‚ùå Rifiuta</button>
            <button class="ai-btn accept" onclick="acceptAISuggestion()">‚úÖ Accetta</button>
        </div>
    </div>

    <!-- CONFLICT WARNING STYLES -->
    <style>
        .conflict-warning {
            background: #fdf2f2;
            border: 1px solid #fcdada;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            color: #721c24;
            font-size: 11px;
            display: none;
        }

        .conflict-warning-icon {
            color: #e74c3c;
            margin-right: 5px;
        }
    </style>

    <script>
        console.log('üöÄ Caricamento Agenda AI con configurazione centralizzata...');

        // ========================================
        // üîß VERIFICA CONFIGURAZIONE ALL'AVVIO
        // ========================================
        
        function checkConfigurationStatus() {
            const statusEl = document.getElementById('configStatus');
            
            if (!window.CONFIG) {
                showConfigStatus('‚ùå Config.js non caricato!', 'invalid');
                return false;
            }
            
            const validation = validateConfig();
            
            if (!validation.isValid) {
                showConfigStatus(`‚ùå ${validation.errors.length} errori configurazione`, 'invalid');
                console.error('Errori configurazione:', validation.errors);
                return false;
            } else if (validation.warnings.length > 0) {
                showConfigStatus(`‚ö†Ô∏è ${validation.warnings.length} avvisi configurazione`, 'warning');
                console.warn('Avvisi configurazione:', validation.warnings);
                setTimeout(() => hideConfigStatus(), 5000);
                return true;
            } else {
                showConfigStatus('‚úÖ Configurazione OK', 'valid');
                setTimeout(() => hideConfigStatus(), 3000);
                return true;
            }
        }
        
        function showConfigStatus(message, type) {
            const statusEl = document.getElementById('configStatus');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `config-status show ${type}`;
            }
        }
        
        function hideConfigStatus() {
            const statusEl = document.getElementById('configStatus');
            if (statusEl) {
                statusEl.classList.remove('show');
            }
        }

        // ========================================
        // üîó VARIABILI GLOBALI
        // ========================================
        
        let currentWeekStart = new Date();
        let selectedDate = new Date();
        let tasksData = [];
        let clientsData = [];
        let projectsData = [];
        let routinesData = [];
        let googleEvents = [];
        let emailTasks = [];
        let isGoogleConnected = false;
        let isDbConnected = false;
        let currentAISuggestion = null;

        // Istanze principali
        let db, googleIntegration, aiScheduler;

        // ========================================
        // üìß GOOGLE INTEGRATION
        // ========================================

        class GoogleIntegration {
            constructor() {
                this.isSignedIn = false;
                this.auth2 = null;
                this.config = CONFIG.google;
                this.init();
            }

            async init() {
                try {
                    showNotification('üîÑ Inizializzando Google APIs...', 'info');
                    
                    if (!this.config.apiKey || this.config.apiKey.startsWith('INSERISCI_')) {
                        throw new Error('‚ùå Google API Key non configurata in config.js');
                    }
                    
                    if (!this.config.clientId || this.config.clientId.startsWith('INSERISCI_')) {
                        throw new Error('‚ùå Google Client ID non configurato in config.js');
                    }
                    
                    await this.loadGoogleAPIs();
                    await this.initializeGoogleAuth();
                    
                    updateGoogleStatus('connected');
                    showNotification('‚úÖ Google APIs inizializzate!', 'success');
                    
                } catch (error) {
                    console.error('Errore inizializzazione Google:', error);
                    updateGoogleStatus('error');
                    showNotification(error.message, 'error');
                }
            }

            loadGoogleAPIs() {
                return new Promise((resolve, reject) => {
                    if (typeof gapi !== 'undefined') {
                        gapi.load('auth2:client', resolve);
                    } else {
                        reject(new Error('Google APIs non caricate'));
                    }
                });
            }

            async initializeGoogleAuth() {
                await gapi.client.init({
                    apiKey: this.config.apiKey,
                    clientId: this.config.clientId,
                    discoveryDocs: [
                        'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest',
                        'https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'
                    ],
                    scope: this.config.scopes.join(' ')
                });

                this.auth2 = gapi.auth2.getAuthInstance();
                this.isSignedIn = this.auth2.isSignedIn.get();

                this.auth2.isSignedIn.listen((isSignedIn) => {
                    this.isSignedIn = isSignedIn;
                    isGoogleConnected = isSignedIn;
                    updateGoogleAuthButton();
                    
                    if (isSignedIn) {
                        showNotification('‚úÖ Google autenticato!', 'success');
                        this.loadGoogleData();
                    } else {
                        showNotification('‚ùå Disconnesso da Google', 'warning');
                    }
                });

                isGoogleConnected = this.isSignedIn;
                updateGoogleAuthButton();

                if (this.isSignedIn) {
                    await this.loadGoogleData();
                }
            }

            async signIn() {
                try {
                    await this.auth2.signIn();
                } catch (error) {
                    console.error('Errore sign-in:', error);
                    showNotification('‚ùå Errore autenticazione Google', 'error');
                }
            }

            async signOut() {
                try {
                    await this.auth2.signOut();
                    googleEvents = [];
                    emailTasks = [];
                    generateWeeklyCalendar();
                } catch (error) {
                    console.error('Errore sign-out:', error);
                }
            }

            async loadGoogleData() {
                try {
                    updateGoogleStatus('syncing');
                    
                    const [events, emails] = await Promise.all([
                        this.getCalendarEvents(),
                        this.analyzeGmailForTasks()
                    ]);
                    
                    googleEvents = events || [];
                    emailTasks = emails || [];
                    
                    generateWeeklyCalendar();
                    updateDashboardStats();
                    updateGoogleTab();
                    
                    updateGoogleStatus('connected');
                    document.getElementById('lastGoogleSync').textContent = new Date().toLocaleTimeString('it-IT');
                    showNotification(`‚úÖ ${googleEvents.length} eventi e ${emailTasks.length} email`, 'success');
                    
                } catch (error) {
                    console.error('Errore caricamento Google:', error);
                    updateGoogleStatus('error');
                    showNotification('‚ùå Errore sincronizzazione Google', 'error');
                }
            }

            async getCalendarEvents() {
                try {
                    const startTime = new Date(currentWeekStart).toISOString();
                    const endTime = new Date(currentWeekStart.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString();
                    
                    const response = await gapi.client.calendar.events.list({
                        calendarId: this.config.calendarId,
                        timeMin: startTime,
                        timeMax: endTime,
                        singleEvents: true,
                        orderBy: 'startTime'
                    });

                    return response.result.items || [];
                } catch (error) {
                    console.error('Errore eventi calendar:', error);
                    return [];
                }
            }

            async analyzeGmailForTasks() {
                try {
                    const query = 'newer_than:3d (subject:progetto OR subject:sito OR subject:sviluppo OR subject:meeting OR subject:urgente)';
                    
                    const response = await gapi.client.gmail.users.messages.list({
                        userId: 'me',
                        q: query,
                        maxResults: 10
                    });

                    if (!response.result.messages) return [];

                    const emailTasks = [];
                    
                    for (const message of response.result.messages.slice(0, 5)) {
                        const emailData = await gapi.client.gmail.users.messages.get({
                            userId: 'me',
                            id: message.id
                        });

                        const email = emailData.result;
                        const headers = email.payload.headers;
                        
                        const subject = headers.find(h => h.name === 'Subject')?.value || '';
                        const from = headers.find(h => h.name === 'From')?.value || '';
                        const date = headers.find(h => h.name === 'Date')?.value || '';

                        const taskAnalysis = this.analyzeEmailForTask(subject, from);
                        
                        if (taskAnalysis.isTask) {
                            emailTasks.push({
                                id: message.id,
                                subject: subject,
                                from: from,
                                date: new Date(date),
                                analysis: taskAnalysis,
                                processed: false
                            });
                        }
                    }

                    return emailTasks;
                } catch (error) {
                    console.error('Errore analisi Gmail:', error);
                    return [];
                }
            }

            analyzeEmailForTask(subject, from) {
                const taskKeywords = ['progetto', 'sito', 'sviluppo', 'meeting', 'urgente', 'deadline', 'scadenza'];
                const priorityKeywords = ['urgente', 'asap', 'importante'];
                const meetingKeywords = ['meeting', 'call', 'riunione', 'incontro'];

                const lowerSubject = subject.toLowerCase();
                const hasTaskKeywords = taskKeywords.some(keyword => lowerSubject.includes(keyword));
                
                if (!hasTaskKeywords) return { isTask: false };

                const isUrgent = priorityKeywords.some(keyword => lowerSubject.includes(keyword));
                const isMeeting = meetingKeywords.some(keyword => lowerSubject.includes(keyword));
                
                return {
                    isTask: true,
                    suggestedTitle: subject.replace(/^(RE:|FW:)/i, '').trim(),
                    suggestedType: isMeeting ? 'project' : 'work',
                    suggestedDuration: isMeeting ? 1 : 2,
                    priority: isUrgent ? 'high' : 'medium',
                    isMeeting: isMeeting,
                    clientName: this.extractClientName(from)
                };
            }

            extractClientName(from) {
                const match = from.match(/^([^<]+)(?:\s*<.+>)?$/);
                if (match) {
                    return match[1].trim().replace(/['"]/g, '');
                }
                return from.split('@')[0];
            }

            async createCalendarEvent(taskData) {
                try {
                    const startDateTime = new Date(`${taskData.date}T${taskData.time || '09:00'}`);
                    const endDateTime = new Date(startDateTime.getTime() + (taskData.duration || 1) * 60 * 60 * 1000);

                    const event = {
                        summary: taskData.title,
                        description: `Task creato da Agenda AI\n\nCliente: ${taskData.clientName || 'N/A'}\nTipo: ${taskData.type}\n\nCreato automaticamente il ${new Date().toLocaleString('it-IT')}`,
                        start: {
                            dateTime: startDateTime.toISOString(),
                            timeZone: 'Europe/Rome'
                        },
                        end: {
                            dateTime: endDateTime.toISOString(),
                            timeZone: 'Europe/Rome'
                        },
                        reminders: {
                            useDefault: false,
                            overrides: [
                                { method: 'popup', minutes: 15 },
                                { method: 'email', minutes: 60 }
                            ]
                        }
                    };

                    const response = await gapi.client.calendar.events.insert({
                        calendarId: this.config.calendarId,
                        resource: event
                    });

                    return response.result;
                } catch (error) {
                    console.error('Errore creazione evento Calendar:', error);
                    throw error;
                }
            }
        }

        // ========================================
        // üóÑÔ∏è DATABASE MANAGER
        // ========================================

        class AgendaDatabase {
            constructor() {
                this.config = CONFIG.supabase;
                this.isOnline = navigator.onLine;
                this.supabase = null;
                this.init();
            }

            async init() {
                try {
                    if (!this.config.url || this.config.url.startsWith('https://INSERISCI_')) {
                        console.warn('‚ö†Ô∏è Supabase non configurato - modalit√† offline');
                        isDbConnected = false;
                        updateSyncStatus('disconnected');
                        this.loadDemoData();
                        return;
                    }

                    this.supabase = window.supabase.createClient(this.config.url, this.config.anonKey);
                    await this.testConnection();
                    
                } catch (error) {
                    console.error('Errore database:', error);
                    isDbConnected = false;
                    updateSyncStatus('error');
                    this.loadDemoData();
                }
            }

            async testConnection() {
                try {
                    showNotification('üîÑ Testando Supabase...', 'info');
                    updateSyncStatus('connecting');
                    
                    const { data, error } = await this.supabase
                        .from(this.config.tables.tasks)
                        .select('count')
                        .limit(1);
                    
                    if (error) throw error;
                    
                    isDbConnected = true;
                    updateSyncStatus('connected');
                    showNotification('‚úÖ Supabase connesso!', 'success');
                    
                    await this.loadInitialData();
                    
                } catch (error) {
                    console.error('Supabase errore:', error);
                    isDbConnected = false;
                    updateSyncStatus('error');
                    showNotification('‚ö†Ô∏è Database offline - modalit√† demo', 'warning');
                    this.loadDemoData();
                }
            }

            async loadInitialData() {
                try {
                    showNotification('üìä Caricando dati dal database...', 'info');
                    
                    const [tasks, clients, projects, routines] = await Promise.all([
                        this.getTasks(),
                        this.getClients(),
                        this.getProjects(),
                        this.getRoutines()
                    ]);
                    
                    tasksData = tasks || [];
                    clientsData = clients || [];
                    projectsData = projects || [];
                    routinesData = routines || [];
                    
                    generateWeeklyCalendar();
                    updateDashboardStats();
                    populateClientsList();
                    populateProjectsList();
                    
                    showNotification('üìä Dati caricati dal database!', 'success');
                    
                } catch (error) {
                    console.error('Errore caricamento dati:', error);
                    this.loadDemoData();
                }
            }

            loadDemoData() {
                console.log('üìã Caricamento dati demo...');
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);

                tasksData = [
                    {
                        id: 'demo1',
                        title: 'Sviluppo homepage',
                        task_date: formatDateKey(today),
                        task_time: '10:00',
                        duration_hours: 2,
                        type: 'project',
                        status: 'pending',
                        client_name: 'Demo Client',
                        source: 'manual'
                    },
                    {
                        id: 'demo2',
                        title: 'Call cliente',
                        task_date: formatDateKey(tomorrow),
                        task_time: '14:00',
                        duration_hours: 1,
                        type: 'work',
                        status: 'pending',
                        client_name: 'Altro Cliente',
                        source: 'manual'
                    }
                ];

                clientsData = [
                    { id: 'client1', name: 'Demo Client', email: 'demo@email.com', company: 'Demo SRL', hourly_rate: 60, status: 'active' },
                    { id: 'client2', name: 'Altro Cliente', email: 'altro@email.com', company: 'Altro SPA', hourly_rate: 70, status: 'active' }
                ];

                projectsData = [
                    { id: 'proj1', name: 'Progetto Demo', client_name: 'Demo Client', status: 'in_progress', progress: 50, budget: 3000 },
                    { id: 'proj2', name: 'Altro Progetto', client_name: 'Altro Cliente', status: 'planning', progress: 20, budget: 5000 }
                ];

                routinesData = [
                    { id: 'routine1', title: '‚òï Colazione', time_start: '08:00', duration_hours: 0.5, days_of_week: [1,2,3,4,5], is_active: true },
                    { id: 'routine2', title: 'üçΩÔ∏è Pranzo', time_start: '13:00', duration_hours: 1, days_of_week: [1,2,3,4,5], is_active: true },
                    { id: 'routine3', title: 'üêï Passeggiata Babu', time_start: '18:30', duration_hours: 1, days_of_week: [1,2,3,4,5,6,7], is_active: true }
                ];

                // Carica calendario rifiuti per demo
                this.loadWasteCollectionDemo();

                generateWeeklyCalendar();
                updateDashboardStats();
                populateClientsList();
                populateProjectsList();
                
                showNotification('üéØ Modalit√† demo attiva con dati di esempio', 'info');
            }

            loadWasteCollectionDemo() {
                // Aggiungi alcuni eventi raccolta rifiuti per la settimana corrente
                const today = new Date();
                const wasteEvents = [
                    { offset: 0, type: 'CARTA', emoji: 'üìÑ' },
                    { offset: 2, type: 'ORGANICO', emoji: 'üçÉ' },
                    { offset: 4, type: 'PLASTICA E METALLI', emoji: '‚ôªÔ∏è' },
                    { offset: 6, type: 'RESIDUO NON RICICLABILE', emoji: 'üóëÔ∏è' }
                ];

                wasteEvents.forEach(waste => {
                    const wasteDate = new Date(today);
                    wasteDate.setDate(wasteDate.getDate() + waste.offset);
                    
                    tasksData.push({
                        id: 'waste_' + waste.offset,
                        title: `${waste.emoji} ${waste.type}`,
                        task_date: formatDateKey(wasteDate),
                        task_time: '21:00',
                        duration_hours: 0.5,
                        type: 'house',
                        status: 'pending',
                        source: 'waste_collection',
                        description: 'Raccolta differenziata - Esporre dopo le 21:00'
                    });
                });
            }

            async getTasks() {
                if (!isDbConnected || !this.supabase) return [];
                
                try {
                    const startDate = formatDateKey(currentWeekStart);
                    const endDate = formatDateKey(new Date(currentWeekStart.getTime() + 6 * 24 * 60 * 60 * 1000));
                    
                    const { data, error } = await this.supabase
                        .from(this.config.tables.tasks)
                        .select('*')
                        .gte('task_date', startDate)
                        .lte('task_date', endDate)
                        .order('task_date, task_time');
                    
                    if (error) throw error;
                    return data || [];
                } catch (error) {
                    console.error('Errore caricamento task:', error);
                    return [];
                }
            }

            async addTask(taskData) {
                if (!isDbConnected || !this.supabase) {
                    // Modalit√† offline
                    const newTask = {
                        id: 'offline_' + Date.now(),
                        title: taskData.title,
                        task_date: taskData.date,
                        task_time: taskData.time,
                        duration_hours: taskData.duration,
                        type: taskData.type,
                        status: 'pending',
                        client_name: taskData.clientName,
                        source: taskData.source || 'manual'
                    };
                    
                    tasksData.push(newTask);
                    generateWeeklyCalendar();
                    updateDashboardStats();
                    showNotification('‚úÖ Task aggiunto (modalit√† offline)', 'success');
                    return newTask;
                }

                try {
                    showSpinner('addTaskSpinner', true);
                    
                    const { data, error } = await this.supabase
                        .from(this.config.tables.tasks)
                        .insert([{
                            title: taskData.title,
                            description: taskData.description || null,
                            task_date: taskData.date,
                            task_time: taskData.time || null,
                            duration_hours: taskData.duration || 1,
                            type: taskData.type || 'work',
                            priority: taskData.priority || 'medium',
                            client_id: taskData.clientId || null,
                            project_id: taskData.projectId || null,
                            source: taskData.source || 'manual'
                        }])
                        .select()
                        .single();

                    if (error) throw error;
                    
                    await this.loadTasksForWeek();
                    generateWeeklyCalendar();
                    updateDashboardStats();
                    
                    showNotification(`‚úÖ Task "${taskData.title}" aggiunto!`, 'success');
                    return data;
                    
                } catch (error) {
                    console.error('Errore aggiunta task:', error);
                    showNotification('‚ùå Errore aggiunta task: ' + error.message, 'error');
                    throw error;
                } finally {
                    showSpinner('addTaskSpinner', false);
                }
            }

            async getClients() {
                if (!isDbConnected || !this.supabase) return clientsData;
                
                try {
                    const { data, error } = await this.supabase
                        .from(this.config.tables.clients)
                        .select('*')
                        .eq('status', 'active')
                        .order('name');
                    
                    if (error) throw error;
                    return data || [];
                } catch (error) {
                    console.error('Errore caricamento clienti:', error);
                    return clientsData;
                }
            }

            async getProjects() {
                if (!isDbConnected || !this.supabase) return projectsData;
                
                try {
                    const { data, error } = await this.supabase
                        .from(this.config.tables.projects)
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    return data || [];
                } catch (error) {
                    console.error('Errore caricamento progetti:', error);
                    return projectsData;
                }
            }

            async getRoutines() {
                if (!isDbConnected || !this.supabase) return routinesData;
                
                try {
                    const { data, error } = await this.supabase
                        .from(this.config.tables.routines)
                        .select('*')
                        .eq('is_active', true)
                        .order('time_start');
                    
                    if (error) throw error;
                    return data || [];
                } catch (error) {
                    console.error('Errore caricamento routine:', error);
                    return routinesData;
                }
            }

            async loadTasksForWeek() {
                const startDate = formatDateKey(currentWeekStart);
                const endDate = formatDateKey(new Date(currentWeekStart.getTime() + 6 * 24 * 60 * 60 * 1000));
                const weekTasks = await this.getTasks(startDate, endDate);
                
                // Aggiorna solo i task della settimana corrente
                tasksData = tasksData.filter(task => {
                    const taskDate = task.task_date;
                    return taskDate < startDate || taskDate > endDate;
                }).concat(weekTasks);
            }
        }

        // ========================================
        // ü§ñ AI SCHEDULER
        // ========================================

        class AIScheduler {
            constructor() {
                this.workingHours = CONFIG.app.workingHours;
                this.lunchBreak = this.workingHours.lunchBreak;
                console.log('ü§ñ AI Scheduler inizializzato');
            }

            findOptimalSlot(taskData, constraints = {}) {
                const duration = parseFloat(taskData.duration) || 1;
                const priority = taskData.priority || 'medium';
                const type = taskData.type || 'work';
                
                const suggestions = [];
                
                // Analizza settimana corrente + prossima
                for (let dayOffset = 0; dayOffset < 14; dayOffset++) {
                    const date = new Date(currentWeekStart);
                    date.setDate(date.getDate() + dayOffset);
                    
                    // Skip weekend se non specificato
                    if (date.getDay() === 0 || date.getDay() === 6) continue;
                    
                    const daySlots = this.analyzeDayAvailability(date, duration);
                    
                    daySlots.forEach(slot => {
                        const score = this.calculateSlotScore(slot, taskData, date);
                        suggestions.push({
                            date: new Date(date),
                            time: slot.time,
                            duration: duration,
                            score: score,
                            reason: slot.reason,
                            conflicts: slot.conflicts || []
                        });
                    });
                }
                
                // Ordina per score e restituisci i migliori
                suggestions.sort((a, b) => b.score - a.score);
                return suggestions.slice(0, 3);
            }

            analyzeDayAvailability(date, duration) {
                const dateKey = formatDateKey(date);
                const dayOfWeek = date.getDay();
                const slots = [];
                
                // Ottieni eventi esistenti per il giorno
                const dayTasks = tasksData.filter(task => task.task_date === dateKey);
                const dayGoogleEvents = googleEvents.filter(event => {
                    if (!event.start?.dateTime) return false;
                    const eventDate = new Date(event.start.dateTime);
                    return formatDateKey(eventDate) === dateKey;
                });
                const dayRoutines = routinesData.filter(routine => 
                    routine.days_of_week.includes(dayOfWeek || 7)
                );
                
                // Analizza ogni ora lavorativa
                for (let hour = this.workingHours.start; hour <= this.workingHours.end - duration; hour++) {
                    const timeSlot = `${hour.toString().padStart(2, '0')}:00`;
                    
                    // Controlla conflitti
                    const conflicts = this.checkConflicts(hour, duration, dayTasks, dayGoogleEvents, dayRoutines);
                    
                    if (conflicts.length === 0) {
                        // Slot libero
                        const reason = this.getSlotReason(hour, dayOfWeek);
                        slots.push({
                            time: timeSlot,
                            hour: hour,
                            available: true,
                            reason: reason,
                            conflicts: []
                        });
                    }
                }
                
                return slots;
            }

            checkConflicts(hour, duration, dayTasks, dayGoogleEvents, dayRoutines) {
                const conflicts = [];
                const endHour = hour + duration;
                
                // Controlla task esistenti
                dayTasks.forEach(task => {
                    if (task.task_time) {
                        const taskHour = parseInt(task.task_time.split(':')[0]);
                        const taskDuration = task.duration_hours || 1;
                        
                        if (this.timesOverlap(hour, endHour, taskHour, taskHour + taskDuration)) {
                            conflicts.push({
                                type: 'task',
                                title: task.title,
                                time: task.task_time
                            });
                        }
                    }
                });
                
                // Controlla eventi Google
                dayGoogleEvents.forEach(event => {
                    const startTime = new Date(event.start.dateTime);
                    const endTime = new Date(event.end.dateTime);
                    const eventHour = startTime.getHours();
                    const eventEndHour = endTime.getHours() + (endTime.getMinutes() > 0 ? 1 : 0);
                    
                    if (this.timesOverlap(hour, endHour, eventHour, eventEndHour)) {
                        conflicts.push({
                            type: 'google-event',
                            title: event.summary,
                            time: startTime.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })
                        });
                    }
                });
                
                // Controlla routine
                dayRoutines.forEach(routine => {
                    const routineHour = parseInt(routine.time_start.split(':')[0]);
                    const routineDuration = routine.duration_hours || 1;
                    
                    if (this.timesOverlap(hour, endHour, routineHour, routineHour + routineDuration)) {
                        conflicts.push({
                            type: 'routine',
                            title: routine.title,
                            time: routine.time_start
                        });
                    }
                });
                
                // Controlla pausa pranzo
                if (this.timesOverlap(hour, endHour, this.lunchBreak.start, this.lunchBreak.end)) {
                    conflicts.push({
                        type: 'lunch',
                        title: 'Pausa pranzo',
                        time: `${this.lunchBreak.start}:00`
                    });
                }
                
                return conflicts;
            }

            timesOverlap(start1, end1, start2, end2) {
                return start1 < end2 && end1 > start2;
            }

            calculateSlotScore(slot, taskData, date) {
                let score = 100;
                const hour = slot.hour;
                const dayOfWeek = date.getDay();
                const daysFromNow = Math.floor((date - new Date()) / (1000 * 60 * 60 * 24));
                
                // Preferenza oraria
                if (hour >= 9 && hour <= 11) {
                    score += 20; // Mattina preferita
                } else if (hour >= 14 && hour <= 16) {
                    score += 15; // Primo pomeriggio
                } else if (hour >= 17) {
                    score -= 10; // Tardo pomeriggio
                }
                
                // Preferenza giorno settimana
                if (dayOfWeek >= 1 && dayOfWeek <= 3) {
                    score += 15; // Inizio settimana
                } else if (dayOfWeek === 5) {
                    score -= 5; // Venerd√¨
                }
                
                // Urgenza task
                if (taskData.priority === 'high') {
                    score -= daysFromNow * 5; // Preferisce giorni vicini
                } else if (taskData.priority === 'low') {
                    score += daysFromNow * 2; // Pu√≤ essere posticipato
                }
                
                return Math.max(0, score);
            }

            getSlotReason(hour, dayOfWeek) {
                const dayNames = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
                
                if (hour >= 9 && hour <= 11) {
                    return `${dayNames[dayOfWeek]} mattina - Produttivit√† alta`;
                } else if (hour >= 14 && hour <= 16) {
                    return `${dayNames[dayOfWeek]} pomeriggio - Buono per meeting`;
                } else if (hour >= 17) {
                    return `${dayNames[dayOfWeek]} tardo pomeriggio - Disponibile`;
                }
                
                return `${dayNames[dayOfWeek]} - Slot disponibile`;
            }

            generateWeekOptimization() {
                const suggestions = [];
                const currentTasks = tasksData.filter(task => {
                    const taskDate = new Date(task.task_date);
                    return taskDate >= currentWeekStart && taskDate < new Date(currentWeekStart.getTime() + 7 * 24 * 60 * 60 * 1000);
                });
                
                // Analizza carico lavoro giornaliero
                const dailyLoad = {};
                currentTasks.forEach(task => {
                    const date = task.task_date;
                    dailyLoad[date] = (dailyLoad[date] || 0) + (task.duration_hours || 1);
                });
                
                // Suggerimenti per bilanciamento
                Object.entries(dailyLoad).forEach(([date, hours]) => {
                    if (hours > 8) {
                        suggestions.push({
                            type: 'overload',
                            date: date,
                            message: `Giorno sovraccarico (${hours}h). Considera di spostare alcuni task.`,
                            severity: 'high'
                        });
                    } else if (hours < 4) {
                        suggestions.push({
                            type: 'underload',
                            date: date,
                            message: `Giorno con poco carico (${hours}h). Puoi aggiungere altri task.`,
                            severity: 'low'
                        });
                    }
                });
                
                return suggestions;
            }
        }

        // ========================================
        // üõ†Ô∏è FUNZIONI UTILIT√Ä
        // ========================================

        function showNotification(message, type = 'info') {
            const bar = document.getElementById('notificationBar');
            if (!bar) {
                console.log(`[${type.toUpperCase()}] ${message}`);
                return;
            }
            
            bar.className = `notification-bar show ${type}`;
            bar.textContent = message;
            
            const duration = CONFIG.ui?.notifications?.duration || 4000;
            setTimeout(() => bar.classList.remove('show'), duration);
        }

        function updateSyncStatus(status) {
            const indicator = document.getElementById('syncIndicator');
            const text = document.getElementById('syncStatusText');
            
            if (!indicator || !text) return;
            
            indicator.className = `sync-indicator ${status}`;
            
            const statusTexts = {
                'connecting': 'Connettendo...',
                'connected': 'Online',
                'syncing': 'Sync...',
                'error': 'Offline',
                'disconnected': 'Disconnesso'
            };
            
            text.textContent = statusTexts[status] || 'Sconosciuto';
        }

        function updateGoogleStatus(status) {
            const indicator = document.getElementById('googleIndicator');
            const text = document.getElementById('googleStatusText');
            
            if (!indicator || !text) return;
            
            indicator.className = `google-indicator ${status}`;
            
            const statusTexts = {
                'connecting': 'Connettendo...',
                'connected': 'Connesso',
                'syncing': 'Sync...',
                'error': 'Errore',
                'disconnected': 'Disconnesso'
            };
            
            text.textContent = statusTexts[status] || 'Google';
        }

        function updateGoogleAuthButton() {
            const btn = document.getElementById('googleAuthBtn');
            if (!btn) return;
            
            if (isGoogleConnected) {
                btn.innerHTML = '‚úÖ Connesso';
                btn.onclick = () => googleIntegration?.signOut();
            } else {
                btn.innerHTML = 'üìß Connetti';
                btn.onclick = () => googleIntegration?.signIn();
            }
        }

        function showSpinner(elementId, show) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (show) {
                element.innerHTML = '<span class="spinner"></span>';
            } else {
                element.innerHTML = '';
            }
        }

        function formatDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        function formatDateDisplay(date) {
            const options = { 
                weekday: 'long', 
                day: 'numeric',
                month: 'long'
            };
            return date.toLocaleDateString(CONFIG.app.defaultLanguage || 'it-IT', options);
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        // ========================================
        // üìÖ FUNZIONI CALENDARIO
        // ========================================

        function generateWeeklyCalendar() {
            const grid = document.getElementById('weeklyGrid');
            if (!grid) return;
            
            grid.innerHTML = '';

            // Header vuoto per colonna ore
            const emptyHeader = document.createElement('div');
            emptyHeader.className = 'time-header';
            grid.appendChild(emptyHeader);

            // Header giorni della settimana
            const dayNames = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];
            const today = new Date();
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                
                if (formatDateKey(date) === formatDateKey(today)) {
                    dayHeader.classList.add('today');
                }
                
                dayHeader.innerHTML = `
                    <div class="day-date">${date.getDate()}</div>
                    <div class="day-name">${dayNames[i]}</div>
                `;
                
                grid.appendChild(dayHeader);
            }

            // Righe orarie (7:00 - 22:00)
            for (let hour = 7; hour <= 22; hour++) {
                const timeSlot = document.createElement('div');
                timeSlot.className = 'time-slot';
                timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
                grid.appendChild(timeSlot);

                // Celle per ogni giorno
                for (let day = 0; day < 7; day++) {
                    const date = new Date(currentWeekStart);
                    date.setDate(date.getDate() + day);
                    const dateKey = formatDateKey(date);
                    const timeKey = `${hour.toString().padStart(2, '0')}:00`;

                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell';
                    dayCell.onclick = () => selectDateAndTime(date, timeKey);
                    
                    const cellContent = document.createElement('div');
                    cellContent.className = 'cell-content';
                    
                    // Aggiungi routine
                    routinesData.forEach(routine => {
                        if (routine.time_start === timeKey && routine.days_of_week.includes(date.getDay() || 7)) {
                            const routineChip = document.createElement('div');
                            routineChip.className = 'event-chip routine';
                            routineChip.innerHTML = `${routine.title}<span class="event-source">R</span>`;
                            routineChip.title = routine.description || routine.title;
                            cellContent.appendChild(routineChip);
                        }
                    });

                    // Aggiungi task dal database
                    tasksData.forEach(task => {
                        if (task.task_date === dateKey && task.task_time && task.task_time.startsWith(timeKey.substring(0, 2))) {
                            const taskChip = document.createElement('div');
                            taskChip.className = `event-chip ${task.type || 'work'}`;
                            
                            if (task.source === 'email') {
                                taskChip.classList.add('email-task');
                            }
                            
                            const displayTitle = task.title.length > 12 ? 
                                task.title.substring(0, 9) + '...' : task.title;
                            
                            taskChip.innerHTML = `${displayTitle}<span class="event-source">${task.source === 'email' ? 'E' : 'T'}</span>`;
                            taskChip.title = `${task.title}${task.client_name ? ' - ' + task.client_name : ''}`;
                            taskChip.onclick = (e) => {
                                e.stopPropagation();
                                showTaskDetails(task);
                            };
                            cellContent.appendChild(taskChip);
                        }
                    });

                    // Aggiungi eventi Google
                    googleEvents.forEach(event => {
                        if (!event.start?.dateTime) return;
                        
                        const eventDate = new Date(event.start.dateTime);
                        const eventHour = eventDate.getHours();
                        
                        if (formatDateKey(eventDate) === dateKey && eventHour === hour) {
                            const googleChip = document.createElement('div');
                            googleChip.className = 'event-chip google-event';
                            
                            const displayTitle = event.summary.length > 12 ? 
                                event.summary.substring(0, 9) + '...' : event.summary;
                            
                            googleChip.innerHTML = `${displayTitle}<span class="event-source">G</span>`;
                            googleChip.title = `${event.summary} (Google Calendar)`;
                            googleChip.onclick = (e) => {
                                e.stopPropagation();
                                showGoogleEventDetails(event);
                            };
                            cellContent.appendChild(googleChip);
                        }
                    });

                    // Verifica conflitti
                    if (cellContent.children.length > 1) {
                        dayCell.classList.add('conflict');
                    }

                    dayCell.appendChild(cellContent);
                    grid.appendChild(dayCell);
                }
            }

            updateWeekDisplay();
            updateSelectedDayInfo();
        }

        function selectDateAndTime(date, time) {
            selectedDate = new Date(date);
            
            // Rimuovi selezione precedente
            document.querySelectorAll('.day-cell.selected').forEach(cell => {
                cell.classList.remove('selected');
            });
            
            // Aggiungi selezione
            event.currentTarget.classList.add('selected');
            
            updateSelectedDayInfo();
            
            // Aggiorna form task
            const taskDateField = document.getElementById('taskDate');
            const taskTimeField = document.getElementById('taskTime');
            if (taskDateField) taskDateField.value = formatDateKey(date);
            if (taskTimeField) taskTimeField.value = time;
            
            // Verifica conflitti per lo slot selezionato
            checkSlotConflicts(date, time);
        }

        function checkSlotConflicts(date, time) {
            const dateKey = formatDateKey(date);
            const hour = parseInt(time.split(':')[0]);
            const conflictWarning = document.getElementById('conflictWarning');
            const conflictText = document.getElementById('conflictText');
            
            if (!conflictWarning || !conflictText) return;
            
            const conflicts = aiScheduler.checkConflicts(hour, 1, 
                tasksData.filter(t => t.task_date === dateKey),
                googleEvents.filter(e => e.start?.dateTime && formatDateKey(new Date(e.start.dateTime)) === dateKey),
                routinesData.filter(r => r.days_of_week.includes(date.getDay() || 7))
            );
            
            if (conflicts.length > 0) {
                const conflictList = conflicts.map(c => c.title).join(', ');
                conflictText.textContent = `Conflitto rilevato con: ${conflictList}`;
                conflictWarning.style.display = 'block';
            } else {
                conflictWarning.style.display = 'none';
            }
        }

        function updateSelectedDayInfo() {
            const dateStr = formatDateDisplay(selectedDate);
            const dateKey = formatDateKey(selectedDate);
            
            document.getElementById('selectedDate').textContent = dateStr;
            
            // Filtra eventi per il giorno selezionato
            const dayTasks = tasksData.filter(task => task.task_date === dateKey);
            const dayGoogleEvents = googleEvents.filter(event => {
                if (!event.start?.dateTime) return false;
                return formatDateKey(new Date(event.start.dateTime)) === dateKey;
            });
            const dayRoutines = routinesData.filter(routine => 
                routine.days_of_week.includes(selectedDate.getDay() || 7)
            );
            
            let scheduleHTML = '';

            // Genera schedule dettagliato per ore
            for (let hour = 7; hour <= 23; hour++) {
                const timeSlot = hour.toString().padStart(2, '0') + ':00';
                let activities = [];

                // Routine
                dayRoutines.forEach(routine => {
                    if (routine.time_start === timeSlot) {
                        activities.push({
                            text: routine.title,
                            type: 'fixed',
                            time: timeSlot,
                            source: 'routine'
                        });
                    }
                });

                // Task programmati
                dayTasks.forEach(task => {
                    if (task.task_time && task.task_time.startsWith(timeSlot.substring(0, 2))) {
                        const statusIcon = task.status === 'completed' ? '‚úÖ' : 
                                          task.status === 'in_progress' ? 'üîÑ' : '‚è≥';
                        const sourceIcon = task.source === 'email' ? 'üìß' : 
                                          task.source === 'waste_collection' ? 'üóëÔ∏è' : 'üìã';
                        
                        activities.push({
                            text: `${statusIcon} ${sourceIcon} ${task.title}`,
                            type: 'flexible',
                            time: task.task_time,
                            source: task.source,
                            data: task
                        });
                    }
                });

                // Eventi Google
                dayGoogleEvents.forEach(event => {
                    if (!event.start?.dateTime) return;
                    
                    const eventDate = new Date(event.start.dateTime);
                    const eventHour = eventDate.getHours();
                    
                    if (eventHour === hour) {
                        const startTime = eventDate.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                        activities.push({
                            text: `üìÖ ${event.summary}`,
                            type: 'fixed',
                            time: startTime,
                            source: 'google'
                        });
                    }
                });

                if (activities.length > 0) {
                    scheduleHTML += `<div class="time-slot-detail">
                        <div class="time-label">${timeSlot}</div>
                        <div class="time-content">`;
                    
                    activities.forEach(activity => {
                        scheduleHTML += `<div class="activity ${activity.type}" onclick="showActivityDetails('${JSON.stringify(activity).replace(/"/g, '&quot;')}')">${activity.text}</div>`;
                    });
                    
                    scheduleHTML += '</div></div>';
                }
            }

            if (!scheduleHTML) {
                scheduleHTML = '<div style="text-align: center; color: #7f8c8d; font-style: italic; padding: 40px;">Giorno libero üåÖ<br><small>Clicca su uno slot nel calendario per aggiungere un task</small></div>';
            }
            
            document.getElementById('dailySchedule').innerHTML = scheduleHTML;
        }

        function updateWeekDisplay() {
            const weekEl = document.getElementById('currentWeek');
            const weekRangeEl = document.getElementById('weekRange');
            
            if (!weekEl) return;
            
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
